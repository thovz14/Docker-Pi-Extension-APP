#!/bin/bash

# Stop on error
set -e

# 1. Install dependencies
# We include fonts-fredoka to ensure your UI looks perfect for every user
install_packages python3-tk docker.io wget ca-certificates fonts-fredoka || error "Package installation failed"

# 2. Create application directory in the user's home folder
# Using $HOME ensures it works for any username
APP_DIR="$HOME/.local/share/dockerpi"
mkdir -p "$APP_DIR"

# 3. Download files from your GitHub repository (RAW)
echo "Fetching files from GitHub..."
wget -qN -O "$APP_DIR/dockerpi.py" "https://raw.githubusercontent.com/thovz14/Docker-Pi-Extension-APP/main/dockerpi.py"
wget -qN -O "$APP_DIR/icon.png" "https://raw.githubusercontent.com/thovz14/Docker-Pi-Extension-APP/main/icon-64.png"

# 4. Set permissions
chmod +x "$APP_DIR/dockerpi.py"
sudo usermod -aG docker "$USER"

# 5. Create the Desktop Shortcut (Menu Entry)
# We save this to the user's local applications folder for better compatibility
DESKTOP_PATH="$HOME/.local/share/applications/dockerpi.desktop"
mkdir -p "$HOME/.local/share/applications"

echo "[Desktop Entry]
Name=DockerPi Extension
Comment=Manage your docker containers
Exec=python3 $APP_DIR/dockerpi.py
Icon=$APP_DIR/icon.png
Terminal=false
Type=Application
Categories=Development;Utility;
StartupNotify=true" > "$DESKTOP_PATH"

# Make the shortcut executable
chmod +x "$DESKTOP_PATH"

# 6. Refresh the desktop database to show the icon immediately
update-desktop-database "$HOME/.local/share/applications" &>/dev/null || true

echo "------------------------------------------------"
echo "Installation complete!"
echo "You can find DockerPi Extension in your menu."
echo "NOTE: If this is your first time installing Docker,"
echo "please REBOOT your Pi to apply group permissions."
echo "------------------------------------------------"
